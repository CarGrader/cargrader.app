<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CarGrader</title>
  <link rel="stylesheet" href="/static/style.css"/>
</head>
<body>
  <main class="container">
    <h1 class="app-title">CarGrader</h1>
    <p class="tagline">Is it <em>Great</em> or is it <em>Garbage</em>?</p>

    <section class="controls">
      <div class="selects">
        <label>Year
          <select id="year"></select>
        </label>
        <label>Make
          <select id="make"></select>
        </label>
        <label>Model
          <select id="model"></select>
        </label>
      </div>
      <button id="goBtn" type="button">Get Results</button>
      <div id="err" class="error" hidden></div>
    </section>

    <hr/>

    <section class="score">
      <div id="title"></div>
      <div class="score-wrap">
        <div id="score" class="score-num">—</div>
        <div class="score-sub">
          <div>Out Of 100</div>
          <div id="certainty" class="certainty"></div>
        </div>
      </div>
    </section>

    <div class="details-wrap">
      <button id="detailsBtn" type="button" disabled>Details</button>
      <div id="detailsPanel" class="details-panel" hidden></div>

      <button id="topComplaintsBtn" type="button" disabled>Top Complaints</button>
      <div id="topComplaintsPanel" class="details-panel top-complaints" hidden></div>

      <button id="trimsBtn" type="button" disabled>Trims</button>
      <div id="trimsPanel" class="details-panel trims" hidden></div>

      <button id="historyBtn" type="button" disabled>History</button>
      <div id="historyPanel" class="details-panel history" hidden></div>
    </div>
  </main>

  <script>
    // --- tiny DOM helper ---
    const $ = (sel) => document.querySelector(sel);

    // --- element refs ---
    const yearSel   = $('#year');
    const makeSel   = $('#make');
    const modelSel  = $('#model');
    const goBtn     = $('#goBtn');

    const detailsBtn = $('#detailsBtn');
    const detailsPanel = $('#detailsPanel');

    const topBtn      = $('#topComplaintsBtn');
    const topPanel    = $('#topComplaintsPanel');

    const trimsBtn    = $('#trimsBtn');
    const trimsPanel  = $('#trimsPanel');

    const historyBtn  = $('#historyBtn');
    const historyPanel= $('#historyPanel');

    const errEl    = $('#err');

    // --- utils ---
    function showError(msg){
      errEl.textContent = msg || 'Something went wrong';
      errEl.hidden = false;
      setTimeout(()=>{ errEl.hidden = true; }, 4000);
    }

    async function fetchJSON(url){
      const res = await fetch(url, { credentials: 'same-origin' });
      if (!res.ok){
        const txt = await res.text().catch(()=> '');
        throw new Error(`HTTP ${res.status}: ${txt || res.statusText}`);
      }
      return res.json();
    }

    // Enable/disable secondary buttons as selects change (safe, no TDZ)
    function maybeEnableSecondaryButtons(){
      const ok = !!(yearSel?.value && makeSel?.value && modelSel?.value);
      if (trimsBtn){
        trimsBtn.disabled = !ok;
        if (!ok){ trimsPanel.hidden = true; trimsPanel.innerHTML=''; }
      }
      if (historyBtn){
        historyBtn.disabled = !ok;
        if (!ok){ historyPanel.hidden = true; historyPanel.innerHTML=''; }
      }
      if (topBtn){
        topBtn.disabled = !ok;
        if (!ok){ topPanel.hidden = true; topPanel.innerHTML=''; }
      }
      if (detailsBtn){
        detailsBtn.disabled = !ok;
        if (!ok){ detailsPanel.hidden = true; detailsPanel.innerHTML=''; }
      }
    }

    yearSel.addEventListener('change', maybeEnableSecondaryButtons);
    makeSel.addEventListener('change', maybeEnableSecondaryButtons);
    modelSel.addEventListener('change', maybeEnableSecondaryButtons);

    // --- initial population ---
    async function populate(){
      try{
        const yrs = await fetchJSON('/api/years');
        yearSel.innerHTML = (yrs.years||[]).map(y=>`<option>${y}</option>`).join('');
        const makes = await fetchJSON(`/api/makes?year=${yearSel.value}`);
        makeSel.innerHTML = (makes.makes||[]).map(m=>`<option>${m}</option>`).join('');
        const models = await fetchJSON(`/api/models?year=${yearSel.value}&make=${makeSel.value}`);
        modelSel.innerHTML = (models.models||[]).map(m=>`<option>${m}</option>`).join('');
        maybeEnableSecondaryButtons();
      }catch(e){
        console.error(e);
        showError('Failed to load years/makes/models.');
      }
    }

    // Re-populate dependent selects when parent changes
    yearSel.addEventListener('change', async ()=>{
      try{
        const makes = await fetchJSON(`/api/makes?year=${yearSel.value}`);
        makeSel.innerHTML = (makes.makes||[]).map(m=>`<option>${m}</option>`).join('');
        const models = await fetchJSON(`/api/models?year=${yearSel.value}&make=${makeSel.value}`);
        modelSel.innerHTML = (models.models||[]).map(m=>`<option>${m}</option>`).join('');
        maybeEnableSecondaryButtons();
      }catch(e){ console.error(e); showError('Failed to update selections.'); }
    });
    makeSel.addEventListener('change', async ()=>{
      try{
        const models = await fetchJSON(`/api/models?year=${yearSel.value}&make=${makeSel.value}`);
        modelSel.innerHTML = (models.models||[]).map(m=>`<option>${m}</option>`).join('');
        maybeEnableSecondaryButtons();
      }catch(e){ console.error(e); showError('Failed to update models.'); }
    });

    // --- main actions ---
    async function fetchDetails(year, make, model){
      const qs = new URLSearchParams({year, make, model}).toString();
      const data = await fetchJSON(`/api/score?${qs}`);
      // Title/score
      $('#title').textContent = `${year} ${make} ${model}`;
      $('#score').textContent = data.score?.toString() ?? '—';
      $('#certainty').textContent = data.certainty ? `Certainty: ${Math.round(data.certainty)}%` : '';
      // Enable all secondary buttons after score too
      if (detailsBtn) { detailsBtn.disabled = false; detailsPanel.hidden = true; detailsPanel.innerHTML=''; }
      if (topBtn)     { topBtn.disabled = false;     topPanel.hidden = true;     topPanel.innerHTML=''; }
      if (trimsBtn)   { trimsBtn.disabled = false;   trimsPanel.hidden = true;   trimsPanel.innerHTML=''; }
      if (historyBtn) { historyBtn.disabled = false; historyPanel.hidden = true; historyPanel.innerHTML=''; }
    }

    goBtn.addEventListener('click', async ()=>{
      try{
        const year  = yearSel.value;
        const make  = makeSel.value;
        const model = modelSel.value;
        if (!year || !make || !model) return;
        goBtn.disabled = true;
        await fetchDetails(year, make, model);
      } catch(e){
        console.error(e);
        showError('Failed to get results.');
      } finally {
        goBtn.disabled = false;
      }
    });

    // --- Details button toggle (existing behavior placeholder) ---
    detailsBtn.addEventListener('click', ()=>{
      detailsPanel.hidden = !detailsPanel.hidden;
      if (!detailsPanel.hidden && !detailsPanel.innerHTML.trim()){
        detailsPanel.innerHTML = '<p>Details coming from your existing endpoint.</p>';
      }
    });

    // --- Top Complaints (existing behavior placeholder; keep your original implementation) ---
    topBtn.addEventListener('click', async ()=>{
      try{
        if (!topPanel.hidden && topPanel.innerHTML.trim()) { topPanel.hidden = true; return; }
        topPanel.hidden = false;
        if (!topPanel.innerHTML.trim()){
          topPanel.innerHTML = '<p>Loading top complaints…</p>';
          // Your existing fetch code remains
          // const data = await fetchJSON(`/api/top-complaints?...`);
        }
      }catch(e){ console.error(e); showError('Failed to load top complaints.'); }
    });

    // --- Trims list ---
    trimsBtn.addEventListener('click', async ()=>{
      try{
        if (!trimsPanel.hidden && trimsPanel.innerHTML.trim()) { trimsPanel.hidden = true; return; }
        const year  = yearSel.value;
        const make  = makeSel.value;
        const model = modelSel.value;
        if (!year || !make || !model) return;
        trimsBtn.disabled = true;
        trimsPanel.innerHTML = '';
        const qs = new URLSearchParams({year, make, model}).toString();
        const data = await fetchJSON(`/api/trims?${qs}`);
        if (!data?.ok) throw new Error(data?.error || 'Request failed');

        const list = Array.isArray(data.items) ? data.items : [];
        if (!list.length){
          trimsPanel.innerHTML = '<p>No trim data available.</p>';
          trimsPanel.hidden = false;
          return;
        }

        const table = document.createElement('table');
        table.className = 'trims-table';
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>Trim/Series</th><th>Count</th><th>% of total</th></tr>';
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        list.forEach(it => {
          const tr = document.createElement('tr');
          const name = (it.name || '').trim();
          const count = (typeof it.count === 'number') ? it.count : parseInt(it.count||0,10);
          const pct = (typeof it.percentage === 'number') ? it.percentage : parseFloat(it.percentage||0);
          const pctTxt = isFinite(pct) ? (pct.toFixed(2) + '%') : '—';
          tr.innerHTML = `<td>${name}</td><td>${count.toLocaleString()}</td><td>${pctTxt}</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        trimsPanel.appendChild(table);
        trimsPanel.hidden = false;
      }catch(e){ console.error('trims failed', e); showError('Failed to load trims.'); }
      finally { trimsBtn.disabled = false; }
    });

    // --- History chart ---
    historyBtn.addEventListener('click', async ()=>{
      try{
        if (!historyPanel.hidden && historyPanel.innerHTML.trim()) { historyPanel.hidden = true; return; }
        const year  = yearSel.value;
        const make  = makeSel.value;
        const model = modelSel.value;
        if (!year || !make || !model) return;

        historyBtn.disabled = true;
        historyPanel.innerHTML = '';

        const qs = new URLSearchParams({year, make, model}).toString();
        const data = await fetchJSON(`/api/history?${qs}`);
        if (!data?.ok) throw new Error(data?.error || 'Request failed');

        const items = Array.isArray(data.items) ? data.items : [];
        if (!items.length){
          historyPanel.innerHTML = '<p>No history data available.</p>';
          historyPanel.hidden = false;
          return;
        }

        // Build SVG chart with animation
        const svgNS = 'http://www.w3.org/2000/svg';
        const W = 720, H = 280, m = {t:20,r:20,b:36,l:46};

        const wrap = document.createElement('div');
        wrap.className = 'history-wrap';
        const legend = document.createElement('div');
        legend.className = 'legend';
        legend.innerHTML = '<span class="lg lg-actual"></span> Actual &nbsp;&nbsp; <span class="lg lg-expected"></span> Expected';
        wrap.appendChild(legend);

        const svg = document.createElementNS(svgNS, 'svg');
        svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
        svg.setAttribute('class', 'history-chart');

        const years    = items.map(d => d.year);
        const actuals  = items.map(d => Number(d.actual) || 0);
        const expected = items.map(d => Number(d.expected) || 0);
        const n = items.length;

        const xMin = 0, xMax = Math.max(1, n-1);
        const yMax = Math.max(1, ...actuals, ...expected);

        const x = (i) => m.l + (i - xMin) / (xMax - xMin) * (W - m.l - m.r);
        const y = (v) => m.t + (1 - (v / yMax)) * (H - m.t - m.b);
        const y0 = y(0);

        const axis = document.createElementNS(svgNS, 'g');
        axis.setAttribute('class', 'axis');

        const yAxis = document.createElementNS(svgNS, 'line');
        yAxis.setAttribute('x1', m.l); yAxis.setAttribute('x2', m.l);
        yAxis.setAttribute('y1', m.t); yAxis.setAttribute('y2', H - m.b);
        axis.appendChild(yAxis);

        const xAxis = document.createElementNS(svgNS, 'line');
        xAxis.setAttribute('x1', m.l); xAxis.setAttribute('x2', W - m.r);
        xAxis.setAttribute('y1', H - m.b); xAxis.setAttribute('y2', H - m.b);
        axis.appendChild(xAxis);

        years.forEach((yr, i) => {
          const tx = document.createElementNS(svgNS, 'text');
          tx.setAttribute('x', x(i));
          tx.setAttribute('y', H - m.b + 18);
          tx.setAttribute('text-anchor', 'middle');
          tx.setAttribute('class', 'tick');
          tx.textContent = String(yr);
          axis.appendChild(tx);
        });

        [0,0.25,0.5,0.75,1].forEach(fr => {
          const val = Math.round(yMax * fr);
          const ty = y(val);
          const tx = document.createElementNS(svgNS, 'text');
          tx.setAttribute('x', m.l - 8);
          tx.setAttribute('y', ty + 4);
          tx.setAttribute('text-anchor', 'end');
          tx.setAttribute('class', 'tick');
          tx.textContent = val.toLocaleString();
          axis.appendChild(tx);

          const gl = document.createElementNS(svgNS, 'line');
          gl.setAttribute('x1', m.l);
          gl.setAttribute('x2', W - m.r);
          gl.setAttribute('y1', ty);
          gl.setAttribute('y2', ty);
          gl.setAttribute('class','grid');
          axis.appendChild(gl);
        });

        svg.appendChild(axis);

        const pathActual   = document.createElementNS(svgNS, 'path');
        const pathExpected = document.createElementNS(svgNS, 'path');
        pathActual.setAttribute('class','line-actual');
        pathExpected.setAttribute('class','line-expected');
        svg.appendChild(pathExpected);
        svg.appendChild(pathActual);

        wrap.appendChild(svg);
        historyPanel.appendChild(wrap);
        historyPanel.hidden = false;

        const duration = 900;
        const t0 = performance.now();

        function pathD(series, t){
          let d = '';
          for (let i=0;i<n;i++){
            const xv = x(i);
            const vy = y((series[i] || 0) * t);
            d += (i===0 ? `M ${xv} ${y0}` : '') + ` L ${xv} ${vy}`;
          }
          return d;
        }
        function step(now){
          const t = Math.min(1, (now - t0) / duration);
          pathActual.setAttribute('d', pathD(actuals, t));
          pathExpected.setAttribute('d', pathD(expected, t));
          if (t < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      }catch(e){
        console.error('history failed', e);
        showError('Failed to load history.');
      }finally{
        historyBtn.disabled = false;
      }
    });

    // Kick things off
    populate();
  </script>
</body>
</html>
